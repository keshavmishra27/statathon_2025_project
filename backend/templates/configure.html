{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <h2>‚öôÔ∏è Configure Data Processing for {{ filename }}</h2>
  <form method="POST">

    <!-- üîπ Schema Mapping -->
    <h4>Schema Mapping</h4>
    <table class="table table-bordered table-dark table-sm">
      <thead>
        <tr>
          <th>Original Column</th>
          <th>AI Suggestion</th>
          <th>Map To</th>
        </tr>
      </thead>
      <tbody>
        {% for col in columns %}
        <tr>
          <td>{{ col }}</td>
          <td>{{ ai_suggest.get("schema_mapping", {}).get(col, "Unknown") }}</td>
          <td>
            <select name="map_{{ col }}" class="form-select">
              <option value="">-- Keep as is --</option>
              <option value="Date" {% if ai_suggest.get("schema_mapping", {}).get(col)=="Date" %}selected{% endif %}>Date</option>
              <option value="Numeric" {% if ai_suggest.get("schema_mapping", {}).get(col)=="Numeric" %}selected{% endif %}>Numeric</option>
              <option value="Categorical" {% if ai_suggest.get("schema_mapping", {}).get(col)=="Categorical" %}selected{% endif %}>Categorical</option>
              <option value="Text" {% if ai_suggest.get("schema_mapping", {}).get(col)=="Text" %}selected{% endif %}>Text</option>
              <option value="Income" {% if ai_suggest.get("schema_mapping", {}).get(col)=="Income" %}selected{% endif %}>Income</option>
              <option value="Age" {% if ai_suggest.get("schema_mapping", {}).get(col)=="Age" %}selected{% endif %}>Age</option>
              <option value="FullName" {% if ai_suggest.get("schema_mapping", {}).get(col)=="FullName" %}selected{% endif %}>FullName</option>
              <option value="DateOfBirth" {% if ai_suggest.get("schema_mapping", {}).get(col)=="DateOfBirth" %}selected{% endif %}>DateOfBirth</option>
            </select>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- üîπ Imputation Method -->
    <h4>Missing Value Imputation</h4>
    <select name="imputation_method" class="form-select mb-3">
      <option value="mean" {% if ai_suggest.get("imputation_method")=="mean" %}selected{% endif %}>Mean</option>
      <option value="median" {% if ai_suggest.get("imputation_method")=="median" %}selected{% endif %}>Median</option>
      <option value="mode" {% if ai_suggest.get("imputation_method")=="mode" %}selected{% endif %}>Mode</option>
      <option value="knn" {% if ai_suggest.get("imputation_method")=="knn" %}selected{% endif %}>KNN Imputer</option>
    </select>
    <small class="text-muted">üí° AI suggested: {{ ai_suggest.get("imputation_method", "mean") }}</small>

    <!-- üîπ Outlier Detection -->
    <h4>Outlier Handling</h4>
    <select name="outlier_method" class="form-select mb-3">
      <option value="zscore" {% if ai_suggest.get("outlier_method")=="zscore" %}selected{% endif %}>Z-Score</option>
      <option value="iqr" {% if ai_suggest.get("outlier_method")=="iqr" %}selected{% endif %}>IQR</option>
      <option value="isolationforest" {% if ai_suggest.get("outlier_method")=="isolationforest" %}selected{% endif %}>Isolation Forest</option>
      <option value="none" {% if ai_suggest.get("outlier_method")=="none" %}selected{% endif %}>None</option>
    </select>
    <small class="text-muted">üí° AI suggested: {{ ai_suggest.get("outlier_method", "none") }}</small>

    <!-- üîπ Business Rules -->
    <h4>Custom Rules</h4>
    {% if ai_suggest.get("rules") %}
      <div class="mb-3">
        {% for rule in ai_suggest.get("rules") %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="rules" value="{{ rule }}" id="rule_{{ loop.index }}" checked>
            <label class="form-check-label" for="rule_{{ loop.index }}">{{ rule }}</label>
          </div>
        {% endfor %}
      </div>
    {% endif %}
    <textarea name="rules" class="form-control mb-3" placeholder="Add your own rules (comma separated)"></textarea>
    <small class="text-muted">üí° AI suggested {{ ai_suggest.get("rules")|length }} rules above.</small>

    <!-- üîπ Weight Column -->
    <h4>Weight Column (optional)</h4>
    <select name="weight_column" class="form-select mb-3">
      <option value="">-- None --</option>
      {% for col in columns %}
      <option value="{{ col }}" {% if ai_suggest.get("weight_column")==col %}selected{% endif %}>{{ col }}</option>
      {% endfor %}
    </select>
    <small class="text-muted">üí° AI suggested: {{ ai_suggest.get("weight_column", "None") }}</small>

    <!-- üîπ AI Imputation -->
    <div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" name="ai_impute" id="ai_impute"
        {% if ai_suggest.get("ai_impute") %}checked{% endif %}>
      <label class="form-check-label" for="ai_impute">Enable AI-assisted Imputation</label>
    </div>

    <!-- üîπ Actions -->
    <button type="submit" name="action" value="visualize" class="btn btn-primary">Visualize</button>
    <button type="submit" name="action" value="analyze" class="btn btn-success">Analyze</button>
  </form>
</div>
{% endblock %}
